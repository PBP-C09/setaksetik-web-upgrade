{% extends "base.html" %}
{% load static %}

{% block meta %}
<title>SetakSetik | Meat Up</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<style>
    .showcase-slide {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease-in-out;
        position: absolute;
        width: 100%;
        height: 100%;
        margin: 0 auto;
    }

    .showcase-slide.active {
        opacity: 1;
        transform: translateY(0);
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-card {
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .tab-button {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .tab-button::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #F7B32B;
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .tab-button:hover::after {
        transform: scaleX(1);
    }

    .tab-button.active {
        background-color: #F7B32B;
        transform: scale(1.05);
    }

    .floating-action-button {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 50;
        transition: transform 0.3s ease;
    }

    .floating-action-button:hover {
        transform: scale(1.1);
    }

    .back-to-welcome {
        position: fixed;
        bottom: 2rem;
        left: 2rem;
        z-index: 50;
        transition: transform 0.3s ease;
    }

    .back-to-welcome:hover {
        transform: scale(1.1);
    }

    .showcase-navigation {
        position: absolute;
        top: 50%;
        width: 100%;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        padding: 0 1rem;
        pointer-events: none;
    }

    .showcase-arrow {
        background: rgba(247, 179, 43, 0.8);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.3s ease;
    }

    .showcase-arrow:hover {
        background: rgba(247, 179, 43, 1);
        transform: scale(1.1);
    }

    .message-status {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-pending { background-color: #FCD34D; color: #92400E; }
    .status-accepted { background-color: #34D399; color: #065F46; }
    .status-rejected { background-color: #F87171; color: #991B1B; }

    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #F7B32B;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: none;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        background-color: rgba(62, 39, 35, 0.9);
        color: #fff;
        text-align: center;
        padding: 5px 10px;
        border-radius: 6px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
        font-size: 14px;
        max-width: 200px;
        word-wrap: break-word;
    }

    .floating-action-button .tooltiptext {
        right: 0;
        left: auto;
        transform: translateX(0);
    }

    .back-to-welcome .tooltiptext {
        left: 0;
        transform: translateX(0);
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }

    .success-message {
        background-color: rgba(52, 211, 153, 0.8) !important;
        color: #065F46 !important;
    }

    .error-message {
        background-color: rgba(248, 113, 113, 0.8) !important;    
</style>
{% endblock meta %}

{% block content %}
<div id="welcomeSection" class="container mx-auto px-4 py-8">
    <h1 class="text-[42px] text-4xl font-reguler text-[#F5F5DC] text-center mb-8 fade-in">
        Welcome to <span class="italic">Meat Up</span>!
    </h1>
    
    <div class="relative h-[500px] mb-16">
        <div class="showcase-slide bg-[#F5F5DC] rounded-lg p-8 text-center">
            <div class="text-6xl mb-8">ðŸ‘¥</div>
            <h2 class="text-2xl font-bold text-[#3E2723] mb-4">Connect with Steak Lovers</h2>
            <p class="text-lg text-[#6D4C41]">Find and connect with fellow steak enthusiasts in your area!</p>
            <div class="mt-8 flex justify-center space-x-4">
                <div class="w-2 h-2 bg-[#F7B32B] rounded-full"></div>
                <div class="w-2 h-2 bg-[#3E2723] rounded-full opacity-50"></div>
                <div class="w-2 h-2 bg-[#3E2723] rounded-full opacity-50"></div>
            </div>
        </div>
        
        <div class="showcase-slide bg-[#F5F5DC] rounded-lg p-8 text-center">
            <div class="text-6xl mb-8">ðŸ’Œ</div>
            <h2 class="text-2xl font-bold text-[#3E2723] mb-4">Send Meat Up Requests</h2>
            <p class="text-lg text-[#6D4C41]">Easily send and manage your meet-up invitations!</p>
            <div class="mt-8 flex justify-center space-x-4">
                <div class="w-2 h-2 bg-[#3E2723] rounded-full opacity-50"></div>
                <div class="w-2 h-2 bg-[#F7B32B] rounded-full"></div>
                <div class="w-2 h-2 bg-[#3E2723] rounded-full opacity-50"></div>
            </div>
        </div>
        
        <div class="showcase-slide bg-[#F5F5DC] rounded-lg p-8 text-center">
            <div class="text-6xl mb-8">ðŸ¥©</div>
            <h2 class="text-2xl font-bold text-[#3E2723] mb-4">Enjoy Great Company</h2>
            <p class="text-lg text-[#6D4C41]">Share your passion for steak with new friends!</p>
            <div class="mt-8 flex justify-center space-x-4">
                <div class="w-2 h-2 bg-[#3E2723] rounded-full opacity-50"></div>
                <div class="w-2 h-2 bg-[#3E2723] rounded-full opacity-50"></div>
                <div class="w-2 h-2 bg-[#F7B32B] rounded-full"></div>
            </div>
        </div>

        <div class="showcase-navigation">
            <button onclick="previousSlide()" class="showcase-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <button onclick="nextSlide()" class="showcase-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>

    <div class="flex justify-center">
        <button onclick="startMeatUp()" class="bg-[#F7B32B] hover:bg-[#F7A52B] text-white font-semibold py-4 px-8 rounded-lg transition duration-300 transform hover:scale-105 shadow-lg">
            Start Your Meat Up Journey!
        </button>
    </div>
</div>

<div id="mainContent" class="container mx-auto px-4 py-8 hidden">
    <div class="flex justify-center space-x-4 mb-8">
        <button onclick="showTab('received')" class="tab-button bg-[#3E2723] text-white px-6 py-3 rounded-lg" data-tab="received">
            Received ({{ received_messages|length }})
        </button>
        <button onclick="showTab('sent')" class="tab-button bg-[#3E2723] text-white px-6 py-3 rounded-lg" data-tab="sent">
            Sent ({{ sent_messages|length }})
        </button>
        <button onclick="showTab('accepted')" class="tab-button bg-[#3E2723] text-white px-6 py-3 rounded-lg" data-tab="accepted">
            Accepted ({{ accepted_messages|length }})
        </button>
        <button onclick="showTab('rejected')" class="tab-button bg-[#3E2723] text-white px-6 py-3 rounded-lg" data-tab="rejected">
            Rejected ({{ rejected_messages|length }})
        </button>
    </div>

    <div id="statusMessage" class="hidden mb-6"></div>

    <div id="receivedSection" class="message-section hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if received_messages %}
                {% for message in received_messages %}
                    <div class="message-card bg-[#F5F5DC] rounded-lg shadow-lg p-6 relative" data-message-id="{{ message.id }}">
                        <div class="message-status status-pending">Pending</div>
                        <div class="flex flex-col mb-4">
                            <p class="text-xl italic mb-2 font-playfair text-[#3E2723]">From: {{ message.sender.full_name }}</p>
                            <p class="text-sm text-[#6D4C41]">{{ message.timestamp }}</p>
                        </div>
                        <div class="bg-[#3E2723] text-[#F5F5DC] p-4 rounded-lg mb-4">
                            <h3 class="message-title font-semibold text-lg mb-2">{{ message.title }}</h3>
                            <p class="message-content">{{ message.content }}</p>
                        </div>
                        <div class="flex justify-between">
                            <button onclick="handleMessageAction('accept', {{ message.id }})" class="flex items-center space-x-2 bg-[#4CAF50] hover:bg-[#45a049] text-white px-4 py-2 rounded-lg transition duration-300">
                                <span>Accept</span>
                                <div class="loading-spinner" id="accept-spinner-{{ message.id }}"></div>
                            </button>
                            <button onclick="handleMessageAction('reject', {{ message.id }})" class="flex items-center space-x-2 bg-[#842323] hover:bg-[#A13A3A] text-white px-4 py-2 rounded-lg transition duration-300">
                                <span>Reject</span>
                                <div class="loading-spinner" id="reject-spinner-{{ message.id }}"></div>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="col-span-3 text-center text-lg text-[#F5F5DC]">No received messages yet!</p>
            {% endif %}
        </div>
    </div>

    <div id="sentSection" class="message-section hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if sent_messages %}
                {% for message in sent_messages %}
                    <div class="message-card bg-[#F5F5DC] rounded-lg shadow-lg p-6 relative" data-message-id="{{ message.id }}">
                        <div class="message-status status-pending">Pending</div>
                        <div class="flex flex-col mb-4">
                            <p class="text-xl italic mb-2 font-playfair text-[#3E2723]">To: {{ message.receiver.full_name }}</p>
                            <p class="text-sm text-[#6D4C41]">{{ message.timestamp }}</p>
                        </div>
                        <div class="bg-[#3E2723] text-[#F5F5DC] p-4 rounded-lg mb-4">
                            <h3 class="message-title font-semibold text-lg mb-2">{{ message.title }}</h3>
                            <p class="message-content">{{ message.content }}</p>
                        </div>
                        <div class="flex justify-between">
                            <button onclick="handleEdit({{ message.id }})" class="flex items-center space-x-2 bg-[#F7B32B] hover:bg-[#F7A52B] text-white px-4 py-2 rounded-lg transition duration-300">
                                <span>Edit</span>
                            </button>
                            <button onclick="handleDelete({{ message.id }})" class="flex items-center space-x-2 bg-[#842323] hover:bg-[#A13A3A] text-white px-4 py-2 rounded-lg transition duration-300">
                                <span>Delete</span>
                                <div class="loading-spinner" id="delete-spinner-{{ message.id }}"></div>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="col-span-3 text-center text-lg text-[#F5F5DC]">No sent messages yet!</p>
                {% endif %}
            </div>
        </div>
    
        <div id="acceptedSection" class="message-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% if accepted_messages %}
                    {% for message in accepted_messages %}
                        <div class="message-card bg-[#F5F5DC] rounded-lg shadow-lg p-6 relative" data-message-id="{{ message.id }}">
                            <div class="message-status status-accepted">Accepted</div>
                            <div class="flex flex-col mb-4">
                                {% if message.sender.user == request.user %}
                                    <p class="text-xl italic mb-2 font-playfair text-[#3E2723]">To: {{ message.receiver.full_name }}</p>
                                {% else %}
                                    <p class="text-xl italic mb-2 font-playfair text-[#3E2723]">From: {{ message.sender.full_name }}</p>
                                {% endif %}
                                <p class="text-sm text-[#6D4C41]">{{ message.timestamp }}</p>
                            </div>
                            <div class="bg-[#3E2723] text-[#F5F5DC] p-4 rounded-lg mb-4">
                                <h3 class="message-title font-semibold text-lg mb-2">{{ message.title }}</h3>
                                <p class="message-content">{{ message.content }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="col-span-3 text-center text-lg text-[#F5F5DC]">No accepted messages yet!</p>
                {% endif %}
            </div>
        </div>
    
        <div id="rejectedSection" class="message-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% if rejected_messages %}
                    {% for message in rejected_messages %}
                        <div class="message-card bg-[#F5F5DC] rounded-lg shadow-lg p-6 relative" data-message-id="{{ message.id }}">
                            <div class="message-status status-rejected">Rejected</div>
                            <div class="flex flex-col mb-4">
                                {% if message.sender.user == request.user %}
                                    <p class="text-xl italic mb-2 font-playfair text-[#3E2723]">To: {{ message.receiver.full_name }}</p>
                                {% else %}
                                    <p class="text-xl italic mb-2 font-playfair text-[#3E2723]">From: {{ message.sender.full_name }}</p>
                                {% endif %}
                                <p class="text-sm text-[#6D4C41]">{{ message.timestamp }}</p>
                            </div>
                            <div class="bg-[#3E2723] text-[#F5F5DC] p-4 rounded-lg mb-4">
                                <h3 class="message-title font-semibold text-lg mb-2">{{ message.title }}</h3>
                                <p class="message-content">{{ message.content }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="col-span-3 text-center text-lg text-[#F5F5DC]">No rejected messages yet!</p>
                {% endif %}
            </div>
        </div>
        
        <a href="{% url 'meatup:create_message_entry' %}" class="floating-action-button tooltip">
            <button class="bg-[#F7B32B] hover:bg-[#F7A52B] text-white rounded-full p-4 shadow-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
            <span class="tooltiptext">Send New Message</span>
        </a>
    
        <button onclick="backToWelcome()" class="back-to-welcome tooltip">
            <div class="bg-[#3E2723] hover:bg-[#6D4C41] text-white rounded-full p-4 shadow-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </div>
            <span class="tooltiptext">Back to Home</span>
        </button>
    
        <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-[#F5F5DC] p-8 rounded-lg w-full max-w-lg">
                <h2 class="text-2xl font-bold text-[#3E2723] mb-6">Edit Message</h2>
                <form id="editForm" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" id="editMessageId">
                    <div>
                        <label for="editTitle" class="block text-[#3E2723] font-semibold mb-2">Title</label>
                        <input type="text" id="editTitle" name="title" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7B32B] focus:border-transparent text-[#3E2723]">
                    </div>
                    <div>
                        <label for="editContent" class="block text-[#3E2723] font-semibold mb-2">Content</label>
                        <textarea id="editContent" name="content" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7B32B] focus:border-transparent text-[#3E2723]"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-[#F7B32B] hover:bg-[#F7A52B] text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <span>Save Changes</span>
                            <div class="loading-spinner" id="edit-spinner"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    
    <script>

    let currentSlide = 0;
    const slides = document.querySelectorAll('.showcase-slide');
    const totalSlides = slides.length;
    
    function showSlide(index) {
        slides.forEach(slide => {
            slide.classList.remove('active');
        });
        slides[index].classList.add('active');
        currentSlide = index;
        
        updateNavigationDots();
    }
    
    function updateNavigationDots() {
        slides.forEach((slide, index) => {
            const dots = slide.querySelectorAll('.bg-[#3E2723], .bg-[#F7B32B]');
            dots.forEach((dot, dotIndex) => {
                if (dotIndex === currentSlide) {
                    dot.classList.remove('bg-[#3E2723]', 'opacity-50');
                    dot.classList.add('bg-[#F7B32B]');
                } else {
                    dot.classList.remove('bg-[#F7B32B]');
                    dot.classList.add('bg-[#3E2723]', 'opacity-50');
                }
            });
        });
    }
    
    function nextSlide() {
        currentSlide = (currentSlide + 1) % totalSlides;
        showSlide(currentSlide);
    }
    
    function previousSlide() {
        currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
        showSlide(currentSlide);
    }
    
    function showTab(tabName) {
        localStorage.setItem('currentTab', tabName);
        
        document.querySelectorAll('.message-section').forEach(section => {
            section.classList.add('hidden');
        });
        
        const selectedSection = document.getElementById(`${tabName}Section`);
        if (selectedSection) {
            selectedSection.classList.remove('hidden');
        }
        
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
            if (button.getAttribute('data-tab') === tabName) {
                button.classList.add('active');
            }
        });
    }
    
    function startMeatUp() {
        document.getElementById('welcomeSection').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        
        const lastTab = localStorage.getItem('currentTab') || 'received';
        showTab('received');
    }
    
    function backToWelcome() {
        document.getElementById('mainContent').classList.add('hidden');
        document.getElementById('welcomeSection').classList.remove('hidden');
    }
    async function refreshAllTabs() {
        try {
            const response = await fetch('/meatup/refresh-tab/');
            if (!response.ok) throw new Error('Failed to fetch data');
            const data = await response.json();
            
            document.querySelectorAll('.tab-button').forEach(button => {
                const tabName = button.getAttribute('data-tab');
                const count = data[`${tabName}_messages`].length;
                button.textContent = `${tabName.charAt(0).toUpperCase() + tabName.slice(1)} (${count})`;
            });
    
            updateTabSection('received', data.received_messages);
            updateTabSection('sent', data.sent_messages);
            updateTabSection('accepted', data.accepted_messages);
            updateTabSection('rejected', data.rejected_messages);
    
            return data;
        } catch (error) {
            console.error('Error refreshing tabs:', error);
        }
    }
    
    function updateTabSection(sectionName, messages) {
        const section = document.getElementById(`${sectionName}Section`);
        if (!section) return;
    
        const grid = section.querySelector('.grid');
        if (!grid) return;
    
        if (messages.length === 0) {
            grid.innerHTML = `<p class="col-span-3 text-center text-lg text-[#F5F5DC]">No ${sectionName} messages yet!</p>`;
            return;
        }
    
        grid.innerHTML = messages.map(message => `
            <div class="message-card bg-[#F5F5DC] rounded-lg shadow-lg p-6 relative fade-in" data-message-id="${message.id}">
                <div class="message-status status-${message.status.toLowerCase()}">${message.status}</div>
                <div class="flex flex-col mb-4">
                    <p class="text-xl italic mb-2 font-playfair text-[#3E2723]">
                        ${message.sender === currentUser ? `To: ${message.receiver}` : `From: ${message.sender}`}
                    </p>
                    <p class="text-sm text-[#6D4C41]">${message.timestamp}</p>
                </div>
                <div class="bg-[#3E2723] text-[#F5F5DC] p-4 rounded-lg mb-4">
                    <h3 class="message-title font-semibold text-lg mb-2">${message.title}</h3>
                    <p class="message-content">${message.content}</p>
                </div>
                ${getActionButtons(message, sectionName)}
            </div>
        `).join('');
    }
    
    function getActionButtons(message, sectionName) {
        if (sectionName === 'received') {
            return `
                <div class="flex justify-between">
                    <button onclick="handleMessageAction('accept', ${message.id})" class="flex items-center space-x-2 bg-[#4CAF50] hover:bg-[#45a049] text-white px-4 py-2 rounded-lg transition duration-300">
                        <span>Accept</span>
                        <div class="loading-spinner" id="accept-spinner-${message.id}"></div>
                    </button>
                    <button onclick="handleMessageAction('reject', ${message.id})" class="flex items-center space-x-2 bg-[#842323] hover:bg-[#A13A3A] text-white px-4 py-2 rounded-lg transition duration-300">
                        <span>Reject</span>
                        <div class="loading-spinner" id="reject-spinner-${message.id}"></div>
                    </button>
                </div>
            `;
        } else if (sectionName === 'sent') {
            return `
                <div class="flex justify-between">
                    <button onclick="handleEdit(${message.id})" class="flex items-center space-x-2 bg-[#F7B32B] hover:bg-[#F7A52B] text-white px-4 py-2 rounded-lg transition duration-300">
                        <span>Edit</span>
                    </button>
                    <button onclick="handleDelete(${message.id})" class="flex items-center space-x-2 bg-[#842323] hover:bg-[#A13A3A] text-white px-4 py-2 rounded-lg transition duration-300">
                        <span>Delete</span>
                        <div class="loading-spinner" id="delete-spinner-${message.id}"></div>
                    </button>
                </div>
            `;
        }
        return ''; 
    }
    
    async function handleMessageAction(action, messageId) {
        const spinner = document.getElementById(`${action}-spinner-${messageId}`);
        spinner.style.display = 'inline-block';
        
        try {
            const response = await fetch(`/meatup/${action}/${messageId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            
            if (response.ok) {
                await refreshAllTabs();
                showStatusMessage(`Message ${action}ed successfully!`, 'success');
                
                const currentTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
                showTab(currentTab);
            } else {
                showStatusMessage(`Failed to ${action} message.`, 'error');
            }
        } catch (error) {
            showStatusMessage(`Error: ${error.message}`, 'error');
        } finally {
            spinner.style.display = 'none';
        }
    }

    const styleSheet = document.createElement("style");
    styleSheet.textContent = `
        .floating-action-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .back-to-welcome {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 50;
            transition: transform 0.3s ease;
        }
    `;
    document.head.appendChild(styleSheet);
    
    async function handleDelete(messageId) {
        if (!confirm('Are you sure you want to delete this message?')) return;
        
        const spinner = document.getElementById(`delete-spinner-${messageId}`);
        spinner.style.display = 'inline-block';
        
        try {
            const response = await fetch(`/meatup/delete/${messageId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            
            if (response.ok) {
                await refreshAllTabs();
                showStatusMessage('Message deleted successfully!', 'success');
                showTab('sent');
            } else {
                showStatusMessage('Failed to delete message.', 'error');
            }
        } catch (error) {
            showStatusMessage(`Error: ${error.message}`, 'error');
        } finally {
            spinner.style.display = 'none';
        }
    }
    
    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageId = document.getElementById('editMessageId').value;
        const spinner = document.getElementById('edit-spinner');
        spinner.style.display = 'inline-block';
        
        try {
            const response = await fetch(`/meatup/edit/${messageId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    title: document.getElementById('editTitle').value,
                    content: document.getElementById('editContent').value,
                }),
            });
            
            if (response.ok) {
                await refreshAllTabs();
                showStatusMessage('Message updated successfully!', 'success');
                closeEditModal();
                showTab('sent');
            } else {
                showStatusMessage('Failed to update message.', 'error');
            }
        } catch (error) {
            showStatusMessage(`Error: ${error.message}`, 'error');
        } finally {
            spinner.style.display = 'none';
        }
    });

    async function handleEdit(messageId) {
        try {
            const response = await fetch(`/meatup/get-message/${messageId}/`);
            if (!response.ok) throw new Error('Failed to fetch message data');
            
            const message = await response.json();
            
            // Show modal
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            
            // Populate form fields
            document.getElementById('editMessageId').value = messageId;
            document.getElementById('editTitle').value = message.title;
            document.getElementById('editContent').value = message.content;
        } catch (error) {
            console.error('Error fetching message:', error);
            showStatusMessage('Failed to load message data', 'error');
        }
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('editForm').reset();
    }
    
    function showStatusMessage(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = `mb-6 p-4 rounded-lg text-center ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        statusDiv.classList.remove('hidden');
        
        setTimeout(() => {
            statusDiv.classList.add('hidden');
        }, 3000);
    }

async function refreshTab(tabName) {
    try {
        const response = await fetch('/meatup/refresh-tab/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        });
        
        if (response.ok) {
            const data = await response.json();
            updateTabContent(tabName, data);
        }
    } catch (error) {
        console.error('Error refreshing tab:', error);
    }
}
    
document.addEventListener('DOMContentLoaded', () => {
    showSlide(0);
    setInterval(nextSlide, 5000);
    
    const mainContent = document.getElementById('mainContent');
    if (!mainContent.classList.contains('hidden')) {
        const lastTab = localStorage.getItem('currentTab') || 'received';
        showTab(lastTab);
    }
    
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            showTab(tabName);
        });
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeEditModal();
        }
    });
    
    document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('editModal')) {
            closeEditModal();
        }
    });
});

function animateMessages() {
    const messages = document.querySelectorAll('.message-card');
    messages.forEach((message, index) => {
        setTimeout(() => {
            message.classList.add('fade-in');
        }, index * 100);
    });
}

function updateMessageStatus(messageId, newStatus) {
    const messageCard = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageCard) {
        const statusBadge = messageCard.querySelector('.message-status');
        statusBadge.className = `message-status status-${newStatus.toLowerCase()}`;
        statusBadge.textContent = newStatus;
        
        messageCard.style.transform = 'scale(1.05)';
        setTimeout(() => {
            messageCard.style.transform = 'scale(1)';
        }, 300);
    }
}

const contentTextarea = document.getElementById('editContent');
if (contentTextarea) {
    contentTextarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
}

let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchEndX - touchStartX;
    
    if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
            previousSlide();
        } else {
            nextSlide();
        }
    }
}

const scrollPositions = {};

function saveScrollPosition(tabName) {
    scrollPositions[tabName] = window.scrollY;
}

function restoreScrollPosition(tabName) {
    if (scrollPositions[tabName]) {
        window.scrollTo(0, scrollPositions[tabName]);
    }
}

const originalShowTab = showTab;
showTab = function(tabName) {
    const currentTab = localStorage.getItem('currentTab');
    if (currentTab) {
        saveScrollPosition(currentTab);
    }
    
    originalShowTab(tabName);
    
    setTimeout(() => {
        restoreScrollPosition(tabName);
    }, 0);
};

document.addEventListener('DOMContentLoaded', () => {
    animateMessages();
});
</script>
{% endblock content %}